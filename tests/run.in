#!/bin/sh

USAGE="$0 [-b <backend>] [-c] [-k] [-p] [-u] [-w] <script>"

# configure generated
SRCDIR="@srcdir@"
TOPSRCDIR="@top_srcdir@"
LN_S="@LN_S@"

export SRCDIR TOPSRCDIR LN_S

AC_BDB=@BUILD_BDB@
AC_HDB=@BUILD_HDB@
AC_LDBM=@BUILD_LDBM@
AC_MONITOR=@BUILD_MONITOR@
AC_CACHE=@BUILD_CACHE@
AC_WITH_TLS=@WITH_TLS@

export AC_MONITOR AC_CACHE AC_WITH_TLS

if test ! -x ../servers/slapd/slapd ; then
	echo "Could not locate slapd(8)"
	exit 1
fi

if test $AC_BDB = yes ; then
	BACKEND=bdb
elif test $AC_LDBM = yes ; then
	BACKEND=ldbm
elif test $AC_HDB = yes ; then
	BACKEND=hdbm
else
	echo "Not configured with a suitable database backend"
	exit 1
fi

CLEAN=no
WAIT=0
KILLSERVERS=yes
PRESERVE=${PRESERVE-no}
USERDATA=no

while test $# -gt 0 ; do
	case "$1" in
		-b | -backend)
			BACKEND="$2"
			shift; shift ;;

		-c | -clean)
			CLEAN=yes
			shift; shift ;;

		-k | -kill)
			KILLSERVERS=no
			shift ;;

		-p | -preserve)
			PRESERVE=yes
			shift ;;

		-u | -userdata)
			USERDATA=yes
			shift ;;

		-w | -wait)
			WAIT=1
			shift ;;

		-)
			shift
			break ;;

		-*)
			echo "$USAGE"; exit 1
			;;

		*)
			break ;;
	esac
done

export BACKEND WAIT KILLSERVERS PRESERVE USERDATA

if test $# = 0 ; then
	echo "$USAGE"; exit 1
fi

SCRIPTDIR="${SRCDIR}/scripts"
SCRIPTNAME="$1"
shift

if test -x "${SCRIPTDIR}/${SCRIPTNAME}" ; then
	SCRIPT="${SCRIPTDIR}/${SCRIPTNAME}"
elif test -x "`echo ${SCRIPTDIR}/test*-${SCRIPTNAME}`"; then
	SCRIPT="`echo ${SCRIPTDIR}/test*-${SCRIPTNAME}`"
elif test -x "`echo ${SCRIPTDIR}/${SCRIPTNAME}-*`"; then
	SCRIPT="`echo ${SCRIPTDIR}/${SCRIPTNAME}-*`"
else
	echo "run: ${SCRIPTNAME} not found (or not executable)"
	exit 1;
fi

if test ! -r testdata/test.ldif ; then
	${LN_S} ${SRCDIR}/data testdata
fi
if test ! -r schema/core.schema ; then
	${LN_S} ${TOPSRCDIR}/servers/slapd/schema schema
fi
if test ! -r ucdata/UnicodeData.txt ; then
	${LN_S} ../libraries/liblunicode ucdata
fi

if test -d testrun ; then
	if test $PRESERVE = no ; then
		echo "Cleaning up test run directory leftover from previous run."
		/bin/rm -rf testrun
	elif test $PRESERVE = yes ; then
		echo "Cleaning up only database directories leftover from previous run."
		/bin/rm -rf testrun/db.*
	fi
fi

if test $USERDATA = yes ; then
	if test ! -d userdata ; then
		echo "User data directory (userdata) does not exist."
		exit 1
	fi
	mkdir -p testrun
	cp -R userdata/* testrun
fi

# disable LDAP initialization
LDAPNOINIT=true; export LDAPNOINIT

echo "Running ${SCRIPT}..."
$SCRIPT $*
RC=$?

if test $CLEAN = yes ; then
	echo "Cleaning up test run directory from this run."
	/bin/rm -rf testrun
	echo "Cleaning up symlinks."
	/bin/rm -f testdata schema ucdata
fi

exit $RC
